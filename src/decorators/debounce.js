import React from 'react'
import debounce from 'lodash/debounce'
import PropTypes from 'prop-types'

export default function (debounceTime) {
  return function (Child) {
    return class Debounce extends React.Component {

      static propTypes = {
        variables: PropTypes.object
      }

      constructor (props) {
        super(props)
        this.deboucedDidRecieveProps = debounce(this.didRecieveProps, debounceTime)
        this.state = {props, propsIndex: 1}
      }

      didRecieveProps (props) {
        this.setState(oldState => {
          return {props, debouncing: false, propsIndex: oldState.propsIndex + 1}
        })
      }

      componentWillReceiveProps (nextProps) {
        this.setState({debouncing: true})
        this.deboucedDidRecieveProps(nextProps)
      }

      shouldComponentUpdate (nextProps, nextState) {
        if (nextState.propsIndex !== this.state.propsIndex) return true
        if (nextState.debouncing !== this.state.debouncing) return true
        return false
      }

      render () {
        return <Child ref={ref=>{this.child = ref}} debouncing={this.state.debouncing} {...this.state.props} />
      }

    }
  }
}
